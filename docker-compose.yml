version: '3.8'

services:
  nginx:
    build:
      context: ./nginx
      dockerfile: Dockerfile
    container_name: travelbrain-nginx
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certbot/conf:/etc/letsencrypt:ro
      - ./certbot/www:/var/www/certbot:ro
    networks:
      - travelbrain-network
    depends_on:
      - backend
      - frontend
      - business-rules
    restart: unless-stopped

  certbot:
    image: certbot/certbot
    container_name: travelbrain-certbot
    volumes:
      - ./certbot/conf:/etc/letsencrypt
      - ./certbot/www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew; sleep 12h & wait $${!}; done;'"

  business-rules:
    build:
      context: ./business-rules-backend
      dockerfile: Dockerfile
    container_name: travelbrain-business-rules
    expose:
      - "3005"
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=3005
      - APP_TIMEZONE=${APP_TIMEZONE}
      - CORS_ORIGINS=${CORS_ORIGINS}
    volumes:
      - ./business-rules-backend:/app
      - /app/node_modules
    networks:
      - travelbrain-network
    restart: unless-stopped

  backend:
    build:
      context: ./backend-project
      dockerfile: Dockerfile
    container_name: travelbrain-backend
    expose:
      - "3004"
    environment:
      - NODE_ENV=${NODE_ENV}
      - PORT=3004
      - MONGO_URI=${MONGO_URI}
      - MONGO_DB=${MONGO_DB}
      - OPENWEATHER_API_KEY=${OPENWEATHER_API_KEY}
      - MAPBOX_TOKEN=${MAPBOX_TOKEN}
      - GOOGLE_CLIENT_ID=${GOOGLE_CLIENT_ID}
      - GOOGLE_CLIENT_SECRET=${GOOGLE_CLIENT_SECRET}
      - GOOGLE_CALLBACK_URL=${GOOGLE_CALLBACK_URL}
      - FRONTEND_URL=${FRONTEND_URL}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_EXPIRES_IN=${JWT_EXPIRES_IN}
      - APP_TIMEZONE=${APP_TIMEZONE}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - BUSINESS_RULES_API_URL=${BUSINESS_RULES_API_URL}
    volumes:
      - ./backend-project:/app
      - /app/node_modules
    networks:
      - travelbrain-network
    depends_on:
      - business-rules
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend-react
      dockerfile: Dockerfile
    container_name: travelbrain-frontend
    expose:
      - "80"
    environment:
      - VITE_API_URL=${FRONTEND_URL}
    volumes:
      - ./frontend-react:/app
      - /app/node_modules
    networks:
      - travelbrain-network
    depends_on:
      - backend
    restart: unless-stopped

  facial-recognition:
    build:
      context: ./facial-recognition-service
      dockerfile: Dockerfile
    container_name: travelbrain-facial-recognition
    expose:
      - "8000"
    environment:
      - PORT=8000
      - HOST=0.0.0.0
      - BACKEND_API_URL=${BACKEND_API_URL}
      - MONGO_URI=${MONGO_URI}
      - MONGO_DB=${MONGO_DB}
      - JWT_SECRET=${JWT_SECRET}
      - JWT_ALGORITHM=${JWT_ALGORITHM}
      - JWT_EXPIRES_IN=7
      - FACE_DETECTION_BACKEND=${FACE_DETECTION_BACKEND}
      - FACE_RECOGNITION_MODEL=${FACE_RECOGNITION_MODEL}
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD}
      - CORS_ORIGINS=${CORS_ORIGINS}
      - FACE_DATA_PATH=${FACE_DATA_PATH}
      - TEMP_DATA_PATH=${TEMP_DATA_PATH}
    volumes:
      - ./facial-recognition-service:/app
      - facial-recognition-data:/app/data
    networks:
      - travelbrain-network
    restart: unless-stopped

networks:
  travelbrain-network:
    driver: bridge

volumes:
  facial-recognition-data:
